version: '1.0'

services:
  port: 5050
  type: train
  name: anomaly-forecast
  
  route: '210.217.178.154:5054'
  endpoint: /v1/train

  # set database info.
  database:
    - name: cmp-database
      driver: cmplog
      type: HW-Log
      uri: 'http://172.16.11.247:9090/cmpapi/search'

  # set ml model info.
  import:
    - name: ml-word2vec
      type: embed
      algorithm: word2vec
      uri: ./data/model/word2vec-wiki-words-500-with-normalization
            
    - name: ml-clustering
      type: cluster
      algorithm: kmeans
      uri: 'git://cmp-model-repos-git/kmeans.model'

    - name: ml-forecast
      type: sequential
      algorithm: BiLSTM
      uri: 'git://cmp-model-repos-git/ml-forecast-bilstm.model'

  # set repository info.
  repository:
    - name: cmp-model-repos-git
      type: git
      uri: 'http://{{user}}:{{password}}@210.217.178.154:6060/root/cmp-ai-model-anomaly.git'
      user: root
      pwd: jYWoefMXG0TStvDyFD8h5U9kdV5asvaVnko28+xYatY=
      branch: master
      local: ./data/repos/git

  # set the preprocessing type and method info.
  preprocess:
    - name: cmp-log-token
      type: token
      punctuation: true
      digits: true

  # set the log search period and method.
  searcher:
    - name: train-searcher
      type: train
      scroll: 6h
      ago: 1d

  # set up machine learning hyperparameters and sampling conditions.
  machine:
    - name: ml-clustering
      type: cluster
      algorithm: kmeans
      clusters: 5 # auto
      export: 'git://cmp-model-repos-git/kmeans.model'

    - name: ml-model
      type: sequential
      algorithm: BiLSTM
      unit: 128
      export: 'git://cmp-model-repos-git/ml-forecast-bilstm.model'

    - name: ml-checkpoints
      type: checkpoints
      monitor: val_loss
      save_best_only: true

    - name: ml-hyperparam
      type: hyperparameter
      epochs: 3
      batch: 3
      loss: MeanSquaredError
      optimizer: Adam
      metrics: [MeanAbsoluteError, MeanAbsolutePercentageError]

    - name: ml-early-stopping
      type: earlystopping
      monitor: loss
      patience: 10
      mode: min

    - name: ml-recovery
      type: recovery
      mode: auto

    - name: ml-sampling
      type: sampling
      train: 0.7
      val: 0.3
      test: 0.0
      searcher: ml-train-searcher

    - name: ml-forecast
      type: forecast
      period: 1h
      term: 1m

  # set up machine learning hyperparameters and sampling conditions.
  scheduler:
    - name: ml-train-scheduler
      type: date
      run_date: '2021-11-09 07:08:30'

